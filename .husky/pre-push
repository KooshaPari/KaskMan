#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "🚀 Running pre-push security validation..."

# 1. Final comprehensive secret scan
echo "🔍 Final secrets scan..."
if grep -r --include="*.js" --include="*.json" --exclude-dir=node_modules -E "(sk-[a-zA-Z0-9]{48}|pk_[a-zA-Z0-9]{24}|rk_[a-zA-Z0-9]{24}|xoxb-[0-9]{12}-[0-9]{12}-[a-zA-Z0-9]{24}|ghp_[a-zA-Z0-9]{36}|gho_[a-zA-Z0-9]{36}|github_pat_[a-zA-Z0-9]{22}_[a-zA-Z0-9]{59})" .; then
  echo "❌ Real API keys detected! Push blocked."
  exit 1
fi

# 2. Check for suspicious patterns
echo "🔎 Checking for suspicious patterns..."
if grep -r --include="*.js" --include="*.json" --exclude-dir=node_modules --exclude="*.example*" --exclude="*test*" --exclude="README*" -i "password.*=.*[^{]" . | grep -v "password:" | grep -v "Password" | head -1; then
  echo "⚠️  Potential hardcoded password found. Please review."
  echo "If this is intentional (like test data), add to exclusions."
  read -p "Continue anyway? (y/N): " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    exit 1
  fi
fi

# 3. Run full test suite
echo "🧪 Running full test suite..."
npm test || exit 1

# 4. Build check
echo "🔨 Running build validation..."
npm run build || exit 1

echo "✅ Pre-push validation completed successfully!"